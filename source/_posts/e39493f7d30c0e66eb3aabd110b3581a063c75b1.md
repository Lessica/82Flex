---
title: 关于最小基数的设计 - Design for Minimum Cardinality
categories: 报告
tags: [数据库,最小基数]
date: 2016-04-10 00:10:00
---

# 关于最小基数的设计

## 最小基数

 - 最小基数，表示一个联系实例设计到的实体实例的最小数目。但是，通常我们不把它作为一个具体数值看待，而是把它看成，实体之间联系的一种约束条件，规定了一个实体，它关联着的实体是可选的，还是必需（强制）的。
 - 由于这种联系是两个实体之间的联系，是双向的，每一边又有可选和必需两种情况，所以一共有四种联系类型，这四种联系想必都比较容易理解。
 - 简单举个例子，图中第一个联系，员工和徽章，这之间是一一对应的关系。只要是公司里的员工，就必需有一枚徽章，当然丢了需要补办；而一枚徽章，必需是公司里的员工所持有，员工辞职了，徽章也就无效了，需要扔掉。
 - 第二个联系，员工和计算机，这之间是一对多的关系，但是它们之间并没有强制性，员工可以不用计算机，计算机也可以没有被任何一个员工使用。
 - 再如第三个联系，员工和技能，是可选对强制联系，员工必需要有一定的技能，不然公司要你这个人干嘛？而某项技能，公司里可能没有一个员工拥有。
 - 用鸦脚模型的直线和圆圈分别表示强制和可选。

## 保证最小基数的手段
 - 现在有公司、部门与员工三个实体，这三个实体之间的关系显而易见。
 - 部门一定是归属于具体于某家公司的，而一家公司则不一定要有某个具体的部门。部门与员工之间的联系类似。
 - 书上有一张表总结了保证最小基数的一些手段。

## 父记录必需时的动作
**插入**
 - 现在 82Flex 安全公司 (82Flex Security) 已经成立了，所以需要建立出几个部门，假设现在建立了 市场营销部，信息技术部，人力资源部，当然还有许许多多的其它部门。
 - 在部门这个数据表中，我们进行了插入操作，插入了三条部门记录。插入部门记录的时候，父记录 Company 并没有任何动作。
 - 大家现在看着第179页的图6.29。在插入部门 (Department) 记录的时候，我们需要将新记录的外键 CompanyName 设置为 82Flex Security，这个动作称为获取父记录。
 - 如果获取不到父记录，换句话说，一个部门无法确定它所属的公司，那么这个部门将无法得到创建，也就是被禁止 (Prohibited)。
 - 现在 82Flex 安全公司 招聘到了第一名员工 Wu Zheng，很显然他是个技术宅，所以要把他安排到信息技术部 (Info Sys.)。在插入员工 (Employee) 记录的时候，我们需要将新记录的外键 DepartmentName 设置为 Info Sys.
 - 这个时候有个人 Jackie Chen 来应聘，但是我们的面试官发现他是一名演员，而公司并不需要演员，所以没有部门可以安排给他。插入员工记录的时候 Jackie Chen 找不到他应该去的地方，所以这次往员工子表中插入记录的动作被禁止了，Jackie Chen 遗憾地离开了公司。

**更新**
 - 在这个例子中，已经升任为首席技术官的 Wu Zheng 想要将 信息技术部 的名称 DepartmentName 改成 Information System。
 - 父表 Department 的主键 DepartmentName 发生了更改，对于信息技术部的全体员工记录，所属的部门外键 DepartmentName 也当然需要更改成 Information System。这个过程我们称之为级联更新 (Cascading Update)。
 - 当然，如果有任何一名员工的部门外键 DepartmentName 无法得到更新，那么父表 Department 的主键就不能更改，也就是被禁止了。
 - 或者，现在要将员工 Xu Wenyuan 调配到 人力资源部，需要将员工记录的部门外键 DepartmentName 更改为 Human Resource Dept.，所以我们首先必须保证新的外键值 Human Resource Dept. 的确与父表中的 人力资源部 这一部门的主键相匹配，才能进行这一次部门调配。

**删除**
 - 现在要考虑删除一条父记录的情况，由于经济不景气， 82Flex Security 打算进行部门精简，并辞退一些员工。
 - 假设现在要取消 人力资源部，暂且不考虑这种行为的合理性，但是如果真的要取消 人力资源部，那么 人力资源部 的所有员工都需要被辞退，否则他们就会无所事事。
 - 父表 Department 中 人力资源部 的记录被删除了，那么子表中部门外键 DepartmentName 的值为 Human Resource Dept. 的全体员工记录就应该被删除。这个过程我们称之为级联删除 (Cascading Deletion)。
 - 顺便提一下，在实际情况中，取消一个部门并不会辞退可怜的员工们，而是把他们调配到其它部门去，比如 市场营销部。也就是给符合条件的员工记录分配一个新的外键 Marketing Dept.，然后再删除 Human Resource Dept. 这条部门记录。
 - 事实上，只要一个部门还有一名员工存在而且不能被辞退或调配到其它部门，那么删除这个部门记录的操作就应该被禁止。

## 子记录必需时的动作
**子记录必需时父表的动作**
 - 现在有一家 82Flex 诊所，这家诊所使用关系型数据库来给病人的治疗情况做记录。
 - 如果医生发现一位病人是第一次来到诊所做治疗，会在第一次治疗完成的基础上为这位病人创建一张病历，并且记录下这位病人的第一次治疗情况。先向父表 病历 Medical History 中插入一条记录，再向子表 治疗记录 Therapy Log 数据表中插入一条记录，并将 这次治疗记录 与 新建的病历 通过外键关联起来，此时父表病历获得了一个子记录——用户的第一次治疗记录。
 - 当这位病人来这家诊所接受治疗的时候都会向 治疗记录 Therapy Log 数据表中插入一条新的子记录，并且都和 这张病历 关联起来。病人只需要出示病历，就可以查询到他所有的治疗记录。
 - 我们规定，没有治疗记录的病历对于患者接下来的治疗是没有任何参考价值的，所以这这属于子记录必需的一种情况。
 - 然而不归属于任何一张病历的治疗记录对于诊所却是有意义的，诊所可以借此分析自身的营业情况，所以这里的病历对于治疗记录不是必须的。父表中要删除某条记录时，子表不需要任何动作。

**子记录必需时子表的动作**
 - 现在假设 82Flex 诊所将外科拆分成了普通外科和整容整形科两个科室，而不同的科室需要有不同的病历，因此诊所需要为病人的一部分符合条件的治疗记录在整容整形科建立新的病历。
 - 那么我们现在要把这位病人原来的治疗记录移动到新的病历当中去。也就是要更新子表中治疗记录的病历外键。
 - 更新治疗记录的病历外键时，我们要检查原来的病历还有没有包含其它的治疗记录，如果还有，则直接更新。如果没有了，正在更新的这条治疗记录是原来的病历的最后一条必需子记录，因此，需要找一个新的替代品，或者禁止此次更新。
 - 在这个例子中，我们可以先删除掉即将没有治疗记录的普通外科病历，然后更新其最后一条治疗记录的外键。

## 对于 M-O 联系的动作实现
 - 在大多数现有的 DBMS (数据库管理系统, DataBase Management System) 中，可以通过定义完整性约束、定义子表中外键为 NOT NULL 来完成 M-O 联系。
 - 可以编写 SQL 语句定义这种完整性约束，也可以选择是否进行级联更新或删除，还是被禁止。

## 对于 O-M 联系的动作实现
 - DBMS 无法提供过多的帮助，大多数情况下，需要使用触发器 (trigger)。
 - 当对一个表进行操作时就会激活触发器的执行，经常用于加强数据的完整性约束和业务规则等。
 - 定义父记录的插入与更新的触发器，并定义子记录更新与删除的触发器。
 - DBMS 无法自动实现触发器的操作，你必须自己编写代码来执行这些规则。

## 对于 M-M 联系的动作实现
 - 保证 M-M 联系的最小基数是非常困难的。
 - 强实体间的 M-M 联系通常是复杂的。
 - 最好的建议是尽量避免 M-M 联系。

## 特殊的 M-M 联系的实现方法
 - 并不是所有的触发器都这样困难。假设现在 电影简介 Film Text 是 ID 依赖弱实体，它必须具有一个 电影 Film 父实体。另外，假定电影必须有电影简介。因此，这个联系是 M-M 联系。
 - 但是，事务通常从强实体开始，也就是说我们对电影简介实体的操作都是通过对电影实体的操作间接进行的。我们不会单独地插入、更新或者删除电影简介，除非插入、更新或删除电影。
 - 因此只需要设定插入、更新或删除电影时的触发器，而不需要对电影简介设定触发器。
 - 插入一条电影记录，必须也插入一条电影简介记录。
 - 更新电影记录的主键——电影名称，也必须更新电影简介的外键。
 - 删除电影记录，也必须删除该电影简介的记录。
